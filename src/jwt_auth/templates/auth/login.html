<!DOCTYPE html>
<html>
<head>
    <title>Авторизация</title>
</head>
<body>
    <h2>Авторизация</h2>
    <form method="post" class="form-control" id="loginForm" >
        {% csrf_token %}
        {{ form.login }}
        {{ form.password }}
        <button type="submit" class="btn btn-success btn-lg">
            <i class="fas fa-check-circle"></i> Авторизоваться
        </button>
    </form>
<script>
// 1. Перехватчик для автоматической подстановки токена
const originalFetch = window.fetch;
window.fetch = async function(url, options = {}) {
    // Для защищённых маршрутов
    if (url.startsWith('/events/')) {
        const token = localStorage.getItem('access_token');
        if (!token) {
            window.location.href = '/login/';
            return Promise.reject('No auth token');
        }
        options.headers = {
            ...options.headers,
            'Authorization': `Bearer ${token}`
        };
    }
    
    // Для авторизации - сохраняем токены из ответа
    if (url.includes('/auth/login/') || url.includes('/auth/register/')) {
        const response = await originalFetch(url, options);
        
        if (response.ok) {
            const data = await response.json();
            if (data.access_token) {
                localStorage.setItem('access_token', data.access_token);
                localStorage.setItem('refresh_token', data.refresh_token);
            }
        }
        
        return response; // Пробрасываем ответ дальше
    }
    
    return originalFetch(url, options);
};
</script>
</body>
</html>