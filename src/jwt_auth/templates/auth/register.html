<!DOCTYPE html>
<html>
<head>
    <title>Регистрация</title>
</head>
<body>
    <h2>Регистрация</h2>
    <form method="post" class="form-control" id="registerForm" >
        {% csrf_token %}
        {{ form.login }}
        {{ form.password }}
        <button type="submit" class="btn btn-success btn-lg">
            <i class="fas fa-check-circle"></i> Зарегестрироваться
        </button>
    </form>
<script>
document.addEventListener('DOMContentLoaded', () => {  // Ждем загрузки DOM
    const form = document.getElementById('registerForm');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    form.addEventListener('submit', async function(e) {
        e.preventDefault();

    const formData = new FormData(this);
    console.log('Отправка запроса...')
    try {
        console.log('Отправка запроса...');
        const response = await fetch('', {  // Отправляем на текущий URL
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'  // Для определения AJAX-запроса
            }
        });
        console.log('Статус ответа:', response.status);

        const data = await response.json();
        
        if (response.ok) {
            // Сохраняем токены
            localStorage.setItem('access_token', data.access_token);
            localStorage.setItem('refresh_token', data.refresh_token);
            
            // Перенаправляем после успешной регистрации
            window.location.href = '/events/';
        } else {
            alert('Ошибка: ' + JSON.stringify(data.errors));
        }
    } catch (error) {
        console.error('Ошибка:', error);
        alert('Ошибка сети');
    }
})
});

// Минимальный перехватчик для API
const originalFetch = window.fetch;
window.fetch = async function(url, options = {}) {
    if (url.startsWith('/api/')) {
        const token = localStorage.getItem('access_token');
        if (token) {
            options.headers = {
                ...options.headers,
                'Authorization': `Bearer ${token}`
            };
        }
    }
    return originalFetch(url, options);
};
</script>
</body>
</html>